# aTES
ДЗ для курса по Асинхронной архитектуре

Идея вкратце:
1. Трекер тречит таски, публикует событие если таск заассайнен.
2. По этому событию списываются деньги с попуга сервисом Accounting. Если таск закрыт, деньги начисляются.
3. В конце для Accounting начинает подбивать результаты и скидывать асинхронно инфу в шину для аналитики. Когда все таски подбиты, считается аналитика
4. Читается все синхронно 

## TaskTracker

### За что отвечает
Создание, завершение, ассайн, получение списка тасков.

### Описание
Входящие запросы синхронные, кроме AssignTasks.
На случай проблем с сетью, зависимостями - ретраи из вызывающего кода.

### Методы:
CreateTask(int popugId, description)
После создания публикуется событие TaskAssigned(int taskId, int popugId) в шину

CompleteTask(int taskId)
После завершения публикуется событие TaskCompleted(int taskId, int popugId)

AssignTasks() - запускает асинхронный процесс ReassignTasks.
По каждому реассайну таска публикуется TaskAssigned(int taskId, int popugId). Прогресс асинхронной задачи нужно сохранять в бд на случай проблем с брокером сообщений

GetTasks(int popugId)

## Accounting

### За что отвечает
Бухгалтерия. Начисление/списывание денег со счета

### Описание

### Методы:
GetAccountInfo(int popugId):
Баланс + лог

### Асинхронные эндпоинты (обработчики, консумеры)
ChargeOnTaskAssigned(TaskAssigned event): списывает со счета попуга деньги после ассайна таска

PayOnTaskCompleted(TaskCompelted event): начисляет деньги после завершения таска

### Публикуемые события
TaskBilled - когда расчитались по таску
AllTasksBilled - когда рассчитались по всем таскам за день

### Джобы
1. CloseBillingJob: считает сколько заработал, обнуляет баланс, отправляет письмо через событие

## Analytics

### За что отвечает
Аналитика, отчеты

### Методы:
GetLoosersCount(): сколько попугов ушлов  минус 
GetProfit(): сколько денег за сегодня заработали
GetMostExpensiveTasks(int days): самые дорогие таски за последние n дней

### Асинхронные эндпоинты (обработчики, консумеры)
OnAllTasksBilled(AllTasksBilled event): когда все таски за день посчитаны, можно сформировать по ним аналитику

OnTaskBilled(TaskBilled event): записать инфо по таску для расчета аналитики за день

## UI+Gateway. Веб приложение
### За что отвечает
Отрисовка дашбордов (UI), авторизация (серверная часть), оркестрация запросов по сервисам

### Описание
Сделано одним веб приложением, на Razor Pages
